<div class="modal-header">
    <h5 class="modal-title" id="formModalLabel">
        <i data-lucide="notebook-pen" class="me-2"></i>
        {{ 'ç¼–è¾‘è®°å½•' if log else 'æ·»åŠ æ–°çºªå½•' }}
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form action="{{ action_url }}" method="POST" onsubmit="event.preventDefault(); submitAjaxForm(this);">
    <div class="modal-body">
        <div class="alert alert-danger error-message" style="display: none;"></div>
        <div class="row g-3">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="log_date" class="form-label">æ—¥æœŸ</label>
                    <input type="date" class="form-control" id="log_date" name="log_date" value="{{ log.log_date.strftime('%Y-%m-%d') if log and log.log_date else default_date.strftime('%Y-%m-%d') }}" required>
                </div>
                <div class="mb-3">
                    <label for="time_slot" class="form-label">æ—¶é—´æ®µ</label>
                    <input type="text" class="form-control" id="time_slot" name="time_slot" value="{{ log.time_slot if log else '' }}" placeholder="ä¾‹å¦‚: 9:00 - 11:30">
                </div>
                <div class="mb-3">
                    <label for="actual_duration" class="form-label">å®é™…æ—¶é•¿ (åˆ†é’Ÿ)</label>
                    <input type="number" class="form-control" id="actual_duration" name="actual_duration" value="{{ log.actual_duration if log else '' }}" placeholder="ä¾‹å¦‚: 120">
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="task" class="form-label">ä»»åŠ¡</label>
                    <input type="text" class="form-control" id="task" name="task" value="{{ log.task if log else '' }}" required placeholder="å­¦ä¹ çš„å…·ä½“å†…å®¹">
                </div>
                <div class="row">
                    <div class="col-sm-6 mb-3">
                        <label for="category" class="form-label">å¤§åˆ†ç±»</label>
                        <select class="form-select" id="category" name="category_id">
                            <option value="">è¯·é€‰æ‹©å¤§åˆ†ç±»</option>
                            {% for category in all_categories %}
                                <option value="{{ category.id }}" {% if log and log.subcategory and log.subcategory.category_id == category.id %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-sm-6 mb-3">
                        <label for="subcategory_id" class="form-label">å°åˆ†ç±»</label>
                        <select class="form-select" id="subcategory_id" name="subcategory_id">
                            <option value="">è¯·å…ˆé€‰æ‹©å¤§åˆ†ç±»</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">å¿ƒæƒ…</label>
                    <div class="d-flex flex-nowrap gap-0">
                         {% for val, emoji in {5: 'ğŸ˜ƒ', 4: 'ğŸ˜Š', 3: 'ğŸ˜', 2: 'ğŸ˜Ÿ', 1: 'ğŸ˜ '}.items() %}
                        <div class="form-check form-check-inline me-0">
                            <input class="btn-check" type="radio" name="mood" id="mood{{ val }}" value="{{ val }}" {% if log and log.mood == val %}checked{% endif %}>
                            <label class="btn btn-outline-secondary" for="mood{{ val }}" style="font-size: 1.5rem; padding: 0.25rem 0.6rem;">{{ emoji }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="col-12">
                 <div class="mb-2">
                    <label for="notes" class="form-label">ç¬”è®°</label>
                    <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="è®°å½•ä¸€äº›å…³é”®ç‚¹æˆ–æƒ³æ³•...">{{ log.notes if log else '' }}</textarea>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="submit" class="btn btn-primary d-flex align-items-center gap-2">
            <i data-lucide="save"></i>
            <span>{{ submit_button_text }}</span>
        </button>
    </div>
</form>

<script>
// BUG FIX: Removed the incorrect DOMContentLoaded wrapper
(function() {
    // å°†åç«¯ä¼ å…¥çš„åˆ†ç±»æ•°æ®è½¬æ¢ä¸ºJSå¯¹è±¡
    const subcategoriesData = {{ all_subcategories|tojson }};
    const categorySelect = document.getElementById('category');
    const subcategorySelect = document.getElementById('subcategory_id');

    // ç”¨äºåœ¨ç¼–è¾‘æ—¶é¢„é€‰ä¸­çš„å°åˆ†ç±»ID
    const selectedSubcategoryId = '{{ log.subcategory_id if log else '' }}';

    function updateSubcategories() {
        const categoryId = categorySelect.value;
        // æ¸…ç©ºå°åˆ†ç±»ä¸‹æ‹‰èœå•
        subcategorySelect.innerHTML = '<option value="">è¯·é€‰æ‹©å°åˆ†ç±»</option>';

        if (categoryId && subcategoriesData[categoryId]) {
            subcategoriesData[categoryId].forEach(function(sub) {
                const option = new Option(sub.name, sub.id);
                subcategorySelect.add(option);
            });
        }

        // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œå¹¶ä¸”å½“å‰é€‰ä¸­çš„å¤§åˆ†ç±»åŒ¹é…ï¼Œåˆ™å°è¯•é€‰ä¸­ä¹‹å‰çš„å°åˆ†ç±»
        if (selectedSubcategoryId) {
             subcategorySelect.value = selectedSubcategoryId;
        }
    }

    // å½“å¤§åˆ†ç±»æ”¹å˜æ—¶ï¼Œæ›´æ–°å°åˆ†ç±»åˆ—è¡¨
    categorySelect.addEventListener('change', updateSubcategories);

    // é¡µé¢åŠ è½½æ—¶ï¼Œå¦‚æœå·²æœ‰é€‰ä¸­çš„å¤§åˆ†ç±»ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰ï¼Œåˆ™ç«‹å³è§¦å‘ä¸€æ¬¡æ›´æ–°
    if (categorySelect.value) {
        updateSubcategories();
    }
})();
</script>