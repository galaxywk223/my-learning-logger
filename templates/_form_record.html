<div class="modal-header">
    <h5 class="modal-title" id="formModalLabel">
        <i data-lucide="notebook-pen" class="me-2"></i>
        {{ 'ç¼–è¾‘è®°å½•' if log else 'æ·»åŠ æ–°çºªå½•' }}
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

{# --- æ ¸å¿ƒä¿®æ­£ï¼šç§»é™¤ onsubmit å±æ€§ï¼Œæ·»åŠ  class="ajax-form" --- #}
<form action="{{ action_url }}" method="POST" class="ajax-form" autocomplete="off">
    <div class="modal-body">
        <div class="alert alert-danger error-message" style="display: none;"></div>

        <div class="mb-3">
            <label for="task" class="form-label">ä»»åŠ¡</label>
            <input type="text" class="form-control form-control-lg" id="task" name="task" value="{{ log.task if log else '' }}" required>
        </div>

        <div class="row g-2 align-items-end mb-3">
            <div class="col-md-4">
                <label for="log_date" class="form-label">æ—¥æœŸ</label>
                <input type="date" class="form-control" id="log_date" name="log_date" value="{{ log.log_date.strftime('%Y-%m-%d') if log and log.log_date else default_date.strftime('%Y-%m-%d') }}" required>
            </div>
            <div class="col-md-4">
                <label for="time_slot" class="form-label">æ—¶é—´æ®µ</label>
                <input type="text" class="form-control" id="time_slot" name="time_slot" value="{{ log.time_slot if log else '' }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">å®é™…æ—¶é•¿</label>
                <div class="input-group">
                    <input type="number" class="form-control" name="duration_hours" min="0" value="{{ (log.actual_duration // 60) if log and log.actual_duration else '' }}">
                    <span class="input-group-text">å°æ—¶</span>
                    <input type="number" class="form-control" name="duration_minutes" min="0" max="59" value="{{ (log.actual_duration % 60) if log and log.actual_duration else '' }}">
                    <span class="input-group-text">åˆ†é’Ÿ</span>
                </div>
            </div>
        </div>

        <div class="row g-2 mb-3">
            <div class="col-sm-6">
                <label for="category" class="form-label">åˆ†ç±»</label>
                <select class="form-select" id="category" name="category_id">
                    <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                    {% for category in all_categories %}
                        <option value="{{ category.id }}" {% if log and log.subcategory and log.subcategory.category_id == category.id %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-sm-6">
                <label for="subcategory_id" class="form-label">æ ‡ç­¾</label>
                <select class="form-select" id="subcategory_id" name="subcategory_id">
                    <option value="">è¯·å…ˆé€‰æ‹©åˆ†ç±»</option>
                </select>
            </div>
        </div>

        <hr class="my-3">

        <div class="row g-3">
            <div class="col-12">
                <label for="notes" class="form-label">ç¬”è®°</label>
                <textarea class="form-control" id="notes" name="notes" rows="3">{{ log.notes if log else '' }}</textarea>
            </div>
            <div class="col-12">
                 <label class="form-label d-block">å¿ƒæƒ…</label>
                 <div class="d-flex flex-nowrap gap-0">
                     {% for val, emoji in {5: 'ğŸ˜ƒ', 4: 'ğŸ˜Š', 3: 'ğŸ˜', 2: 'ğŸ˜Ÿ', 1: 'ğŸ˜ '}.items() %}
                    <div class="form-check form-check-inline me-0">
                        <input class="btn-check" type="radio" name="mood" id="mood{{ val }}" value="{{ val }}" {% if log and log.mood == val %}checked{% endif %}>
                        <label class="btn btn-outline-secondary" for="mood{{ val }}" style="font-size: 1.5rem; padding: 0.25rem 0.6rem;">{{ emoji }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="submit" class="btn btn-primary d-flex align-items-center gap-2">
            <i data-lucide="save"></i>
            <span>{{ submit_button_text }}</span>
        </button>
    </div>
</form>

<script>
(function() {
    const subcategoriesData = {{ all_subcategories|tojson }};
    const categorySelect = document.getElementById('category');
    const subcategorySelect = document.getElementById('subcategory_id');
    const selectedSubcategoryId = '{{ log.subcategory_id if log else '' }}';

    function updateSubcategories() {
        const categoryId = categorySelect.value;
        subcategorySelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ ‡ç­¾</option>';

        if (categoryId && subcategoriesData[categoryId]) {
            subcategoriesData[categoryId].forEach(function(sub) {
                const option = new Option(sub.name, sub.id);
                subcategorySelect.add(option);
            });
        }
        if (selectedSubcategoryId) {
             subcategorySelect.value = selectedSubcategoryId;
        }
    }
    categorySelect.addEventListener('change', updateSubcategories);
    if (categorySelect.value) {
        updateSubcategories();
    }
})();
</script>