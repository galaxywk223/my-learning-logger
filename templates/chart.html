{% extends "base.html" %}

{% block title %}统计图表{% endblock %}

{% block content %}
<style>
    .kpi-card {
        background-color: var(--color-card-bg);
        border: 1px solid #E5E7EB;
        border-left-width: 5px;
        border-radius: var(--border-radius-md);
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        box-shadow: var(--box-shadow);
    }

    .kpi-card .icon-wrapper {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .kpi-card .kpi-value {
        font-family: 'Poppins', sans-serif;
        font-size: 2rem;
        font-weight: 700;
        line-height: 1.2;
        color: var(--color-text-dark);
    }

    .kpi-card .kpi-label {
        font-size: 1rem;
        color: var(--color-text-medium);
    }

    .kpi-card-duration { border-left-color: #F97316; }
    .kpi-card-duration .icon-wrapper { background-color: #FFEDD5; }
    .kpi-card-duration .icon-wrapper i { color: #EA580C; }
    .kpi-card-days { border-left-color: #EF4444; }
    .kpi-card-days .icon-wrapper { background-color: #FEE2E2; }
    .kpi-card-days .icon-wrapper i { color: #DC2626; }
    .kpi-card-avg { border-left-color: var(--color-primary); }
    .kpi-card-avg .icon-wrapper { background-color: var(--color-primary-light); }
    .kpi-card-avg .icon-wrapper i { color: var(--color-primary-dark); }

    .chart-container-wrapper { height: 400px; position: relative; }
    .chart-view-buttons { position: -webkit-sticky; position: sticky; top: 1rem; z-index: 1020; align-self: flex-start; }
</style>

<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1>统计图表</h1>
        <p class="lead text-secondary mb-0">通过数据洞察你的学习模式。</p>
    </div>
    <div class="chart-view-buttons">
        <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-outline-primary active" id="viewWeekly">周视图</button>
            <button type="button" class="btn btn-outline-primary" id="viewDaily">日视图</button>
        </div>
    </div>
</div>

{% if setup_needed %}
<div class="alert alert-warning text-center">
    <h4 class="alert-heading">请先完成初始设置</h4>
    <p>为了查看图表，您需要先在设置页面中指定每周的起始日期并添加一些学习记录。</p>
    <a href="{{ url_for('main.settings') }}" class="btn btn-warning">前往设置</a>
</div>
{% else %}
<div class="row g-4 mb-4">
    <div class="col-lg-4 col-md-6">
        <div class="kpi-card kpi-card-duration">
            <div class="icon-wrapper"><i data-lucide="clock"></i></div>
            <div>
                <div class="kpi-value" id="kpi-total-hours">...</div>
                <div class="kpi-label">总学习时长 (小时)</div>
            </div>
        </div>
    </div>
    <div class="col-lg-4 col-md-6">
        <div class="kpi-card kpi-card-days">
            <div class="icon-wrapper"><i data-lucide="calendar-days"></i></div>
            <div>
                <div class="kpi-value" id="kpi-total-days">...</div>
                <div class="kpi-label">总学习天数</div>
            </div>
        </div>
    </div>
    <div class="col-lg-4 col-md-6">
        <div class="kpi-card kpi-card-avg">
            <div class="icon-wrapper"><i data-lucide="bar-chart-horizontal"></i></div>
            <div>
                <div class="kpi-value" id="kpi-avg-minutes">...</div>
                <div class="kpi-label">平均每日时长 (分钟)</div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-12 mb-4">
        <div class="card h-100">
            <div class="card-header"><h5 class="card-title mb-0">学习时长分析</h5></div>
            <div class="card-body">
                <div class="chart-container-wrapper">
                    <canvas id="durationChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-12">
        <div class="card h-100">
            <div class="card-header"><h5 class="card-title mb-0">学习效率分析</h5></div>
            <div class="card-body">
                <div class="chart-container-wrapper">
                    <canvas id="efficiencyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    lucide.createIcons();

    // 只在需要渲染图表的页面执行JS代码
    {% if not setup_needed %}

    // 全局变量，用于存储从API获取的数据和图表实例
    let dataStore = {};
    let durationChart, efficiencyChart;

    // 当DOM加载完毕后，执行主函数
    document.addEventListener('DOMContentLoaded', () => {

        const durationCtx = document.getElementById('durationChart').getContext('2d');
        const efficiencyCtx = document.getElementById('efficiencyChart').getContext('2d');
        const weeklyBtn = document.getElementById('viewWeekly');
        const dailyBtn = document.getElementById('viewDaily');

        const commonOptions = {
            responsive: true, maintainAspectRatio: false,
            interaction: {mode: 'index', intersect: false},
            plugins: {
                legend: {position: 'bottom', labels: {usePointStyle: true, boxWidth: 8, padding: 20}},
                tooltip: { backgroundColor: '#1f2937', titleFont: {size: 14}, bodyFont: {size: 12}, padding: 10, cornerRadius: 6, boxPadding: 3 }
            },
            scales: {x: {grid: {display: false}}}
        };

        const durationChartConfig = { type: 'bar', options: { ...commonOptions, scales: { ...commonOptions.scales, y: {title: {display: true, text: '学习时长 (小时)'}, grace: '5%'} } } };
        const efficiencyChartConfig = { type: 'bar', options: { ...commonOptions, scales: { ...commonOptions.scales, y: {title: {display: true, text: '学习效率'}, min: 0, max: 5, ticks: {stepSize: 1}} } } };

        // 初始化空图表
        durationChart = new Chart(durationCtx, durationChartConfig);
        efficiencyChart = new Chart(efficiencyCtx, efficiencyChartConfig);

        // --- 主函数：获取数据并渲染 ---
        async function fetchDataAndRender() {
            try {
                // 1. 发起API请求 (*** 已修正此处的URL ***)
                const response = await fetch("/charts/api/data");
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.statusText}`);
                }
                const data = await response.json();

                // 2. 将获取的数据存到全局变量
                dataStore = {
                    weekly: { duration: data.weekly_duration_data, efficiency: data.weekly_efficiency_data },
                    daily: { duration: data.daily_duration_data, efficiency: data.daily_efficiency_data }
                };

                // 3. 更新KPI卡片
                document.getElementById('kpi-total-hours').textContent = data.kpis.total_hours;
                document.getElementById('kpi-total-days').textContent = data.kpis.total_days;
                document.getElementById('kpi-avg-minutes').textContent = data.kpis.avg_daily_minutes;

                // 4. 首次渲染图表 (默认周视图)
                updateCharts('weekly');

            } catch (error) {
                console.error('获取图表数据时出错:', error);
                // 可以在页面上显示一个更友好的错误信息
                document.querySelector('.page-header').insertAdjacentHTML('afterend', '<div class="alert alert-danger">无法加载图表数据，请稍后重试。</div>');
            }
        }

        function updateCharts(view) {
            // 确保 dataStore 已被填充
            if (!dataStore[view]) return;

            durationChart.data = {
                labels: dataStore[view].duration.labels,
                datasets: [
                    { type: 'bar', label: '实际时长', data: dataStore[view].duration.actuals, backgroundColor: 'rgba(251, 146, 60, 0.5)', order: 2 },
                    { type: 'line', label: '趋势', data: dataStore[view].duration.trends, borderColor: '#B45309', tension: 0.4, fill: false, pointRadius: 0, borderWidth: 2.5, order: 1 }
                ]
            };
            efficiencyChart.data = {
                labels: dataStore[view].efficiency.labels,
                datasets: [
                    { type: 'bar', label: '实际效率', data: dataStore[view].efficiency.actuals, backgroundColor: 'rgba(248, 113, 113, 0.5)', order: 2 },
                    { type: 'line', label: '趋势', data: dataStore[view].efficiency.trends, borderColor: '#991B1B', tension: 0.4, fill: false, pointRadius: 0, borderWidth: 2.5, order: 1, spanGaps: true }
                ]
            };
            durationChart.update();
            efficiencyChart.update();
        }

        // 添加按钮事件监听
        weeklyBtn.addEventListener('click', () => {
            updateCharts('weekly');
            weeklyBtn.classList.add('active');
            dailyBtn.classList.remove('active');
        });

        dailyBtn.addEventListener('click', () => {
            updateCharts('daily');
            dailyBtn.classList.add('active');
            weeklyBtn.classList.remove('active');
        });

        // 页面加载后，调用主函数
        fetchDataAndRender();
    });
    {% endif %}
</script>
{% endblock %}