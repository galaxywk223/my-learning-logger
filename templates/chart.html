{% extends "base.html" %}

{% block title %}统计图表{% endblock %}

{% block content %}
<style>
    .kpi-card {
        background-color: var(--color-card-bg);
        border: 1px solid #E5E7EB;
        border-left-width: 5px;
        border-radius: var(--border-radius-md);
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        box-shadow: var(--box-shadow);
    }

    .kpi-card .icon-wrapper {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .kpi-card .kpi-value {
        font-family: 'Poppins', sans-serif;
        font-size: 2rem;
        font-weight: 700;
        line-height: 1.2;
        color: var(--color-text-dark);
    }

    .kpi-card .kpi-label {
        font-size: 1rem;
        color: var(--color-text-medium);
    }

    .kpi-card-duration {
        border-left-color: #F97316;
    }

    .kpi-card-duration .icon-wrapper {
        background-color: #FFEDD5;
    }

    .kpi-card-duration .icon-wrapper i {
        color: #EA580C;
    }

    .kpi-card-days {
        border-left-color: #EF4444;
    }

    .kpi-card-days .icon-wrapper {
        background-color: #FEE2E2;
    }

    .kpi-card-days .icon-wrapper i {
        color: #DC2626;
    }

    .kpi-card-avg {
        border-left-color: var(--color-primary);
    }

    .kpi-card-avg .icon-wrapper {
        background-color: var(--color-primary-light);
    }

    .kpi-card-avg .icon-wrapper i {
        color: var(--color-primary-dark);
    }

    .chart-container-wrapper {
        height: 450px; /* Increased height for annotations */
        position: relative;
    }

    .chart-view-buttons {
        position: -webkit-sticky;
        position: sticky;
        top: 1rem;
        z-index: 1020;
        align-self: flex-start;
    }
</style>

<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1>统计图表</h1>
        <p class="lead text-secondary mb-0">通过数据洞察你的学习模式。</p>
    </div>
    <div class="chart-view-buttons">
        <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-outline-primary active" id="viewWeekly">周视图</button>
            <button type="button" class="btn btn-outline-primary" id="viewDaily">日视图</button>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-lg-4 col-md-6">
        <div class="kpi-card kpi-card-duration">
            <div class="icon-wrapper"><i data-lucide="clock"></i></div>
            <div>
                <div class="kpi-value" id="kpi-total-hours">...</div>
                <div class="kpi-label">总学习时长 (小时)</div>
            </div>
        </div>
    </div>
    <div class="col-lg-4 col-md-6">
        <div class="kpi-card kpi-card-days">
            <div class="icon-wrapper"><i data-lucide="calendar-days"></i></div>
            <div>
                <div class="kpi-value" id="kpi-total-days">...</div>
                <div class="kpi-label">总学习天数</div>
            </div>
        </div>
    </div>
    <div class="col-lg-4 col-md-6">
        <div class="kpi-card kpi-card-avg">
            <div class="icon-wrapper"><i data-lucide="bar-chart-horizontal"></i></div>
            <div>
                <div class="kpi-value" id="kpi-avg-minutes">...</div>
                <div class="kpi-label">平均每日时长 (分钟)</div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-12 mb-4">
        <div class="card h-100">
            <div class="card-header"><h5 class="card-title mb-0">学习时长分析</h5></div>
            <div class="card-body">
                <div class="chart-container-wrapper">
                    <canvas id="durationChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-12">
        <div class="card h-100">
            <div class="card-header"><h5 class="card-title mb-0">学习效率分析</h5></div>
            <div class="card-body">
                <div class="chart-container-wrapper">
                    <canvas id="efficiencyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    lucide.createIcons();

    let dataStore = {};
    let durationChart, efficiencyChart;

    // --- NEW: Chart.js plugin for stage annotations ---
    const stageAnnotationsPlugin = {
        id: 'stageAnnotations',
        afterDraw: (chart) => {
            if (chart.config.options.plugins.stageAnnotations.view !== 'weekly') {
                return;
            }
            const {ctx, chartArea: {bottom, left, right}, scales: {x}} = chart;
            const annotations = chart.config.options.plugins.stageAnnotations.annotations;
            if (!annotations) return;

            ctx.save();
            ctx.font = 'bold 12px "Inter", sans-serif';
            ctx.textAlign = 'center';

            annotations.forEach(anno => {
                const startIndex = chart.data.labels.indexOf(anno.start_week_label);
                const endIndex = chart.data.labels.indexOf(anno.end_week_label);

                if (startIndex === -1 || endIndex === -1) return;

                const startPixel = x.getPixelForValue(startIndex);
                const endPixel = x.getPixelForValue(endIndex);
                const middlePixel = startPixel + (endPixel - startPixel) / 2;

                if (middlePixel < left || middlePixel > right) return;

                // Draw line and text
                ctx.strokeStyle = '#9CA3AF'; // gray-400
                ctx.lineWidth = 1;
                ctx.fillStyle = '#4B5563'; // gray-600

                ctx.beginPath();
                ctx.moveTo(startPixel, bottom + 15);
                ctx.lineTo(endPixel, bottom + 15);
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(middlePixel, bottom + 15);
                ctx.lineTo(middlePixel, bottom + 20);
                ctx.stroke();

                ctx.fillText(anno.name, middlePixel, bottom + 35);
            });
            ctx.restore();
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        const durationCtx = document.getElementById('durationChart').getContext('2d');
        const efficiencyCtx = document.getElementById('efficiencyChart').getContext('2d');
        const weeklyBtn = document.getElementById('viewWeekly');
        const dailyBtn = document.getElementById('viewDaily');

// 这是修改后的代码
        const createChartOptions = (yAxisTitle, yMin, yMax, yStep) => ({
            responsive: true, maintainAspectRatio: false,
            interaction: {mode: 'index', intersect: false},
            layout: {padding: {bottom: 40}}, // Extra padding for annotations
            plugins: {
                legend: {position: 'top', labels: {usePointStyle: true, boxWidth: 8, padding: 20}}, // <-- 修改这里
                tooltip: {
                    backgroundColor: '#1f2937',
                    titleFont: {size: 14},
                    bodyFont: {size: 12},
                    padding: 10,
                    cornerRadius: 6,
                    boxPadding: 3
                },
                stageAnnotations: {annotations: [], view: 'weekly'} // Custom plugin options
            },
            scales: {
                x: {
                    grid: {display: false},
                    ticks: {display: false} // <-- 新增这一行来隐藏X轴的周次标签
                },
                y: {
                    title: {display: true, text: yAxisTitle},
                    min: yMin,
                    max: yMax,
                    ticks: {stepSize: yStep},
                    grace: '5%'
                }
            }
        });

        durationChart = new Chart(durationCtx, {
            type: 'bar',
            options: createChartOptions('学习时长 (小时)'),
            plugins: [stageAnnotationsPlugin]
        });
        efficiencyChart = new Chart(efficiencyCtx, {
            type: 'bar',
            options: createChartOptions('学习效率', 0, 5, 1),
            plugins: [stageAnnotationsPlugin]
        });

        async function fetchDataAndRender() {
            try {
                const response = await fetch("/charts/api/data");
                if (!response.ok) throw new Error(`API request failed: ${response.statusText}`);
                const data = await response.json();

                if (!data.kpis) {
                    document.querySelector('.page-header').insertAdjacentHTML('afterend', '<div class="alert alert-info">暂无数据可供分析。</div>');
                    return;
                }

                dataStore = {
                    weekly: {duration: data.weekly_duration_data, efficiency: data.weekly_efficiency_data},
                    daily: {duration: data.daily_duration_data, efficiency: data.daily_efficiency_data},
                    annotations: data.stage_annotations
                };

                document.getElementById('kpi-total-hours').textContent = data.kpis.total_hours;
                document.getElementById('kpi-total-days').textContent = data.kpis.total_days;
                document.getElementById('kpi-avg-minutes').textContent = data.kpis.avg_daily_minutes;

                updateCharts('weekly');
            } catch (error) {
                console.error('Error fetching chart data:', error);
                document.querySelector('.page-header').insertAdjacentHTML('afterend', '<div class="alert alert-danger">无法加载图表数据，请稍后重试。</div>');
            }
        }

        function updateCharts(view) {
            if (!dataStore[view]) return;

            durationChart.data = {
                labels: dataStore[view].duration.labels,
                datasets: [{
                    type: 'bar',
                    label: '实际时长',
                    data: dataStore[view].duration.actuals,
                    backgroundColor: 'rgba(251, 146, 60, 0.5)',
                    order: 2
                }, {
                    type: 'line',
                    label: '趋势',
                    data: dataStore[view].duration.trends,
                    borderColor: '#B45309',
                    tension: 0.4,
                    fill: false,
                    pointRadius: 0,
                    borderWidth: 2.5,
                    order: 1
                }]
            };
            efficiencyChart.data = {
                labels: dataStore[view].efficiency.labels,
                datasets: [{
                    type: 'bar',
                    label: '实际效率',
                    data: dataStore[view].efficiency.actuals,
                    backgroundColor: 'rgba(248, 113, 113, 0.5)',
                    order: 2
                }, {
                    type: 'line',
                    label: '趋势',
                    data: dataStore[view].efficiency.trends,
                    borderColor: '#991B1B',
                    tension: 0.4,
                    fill: false,
                    pointRadius: 0,
                    borderWidth: 2.5,
                    order: 1,
                    spanGaps: true
                }]
            };

            // Update annotations based on view
            durationChart.config.options.plugins.stageAnnotations = {annotations: dataStore.annotations, view: view};
            efficiencyChart.config.options.plugins.stageAnnotations = {annotations: dataStore.annotations, view: view};

            durationChart.update();
            efficiencyChart.update();
        }

        weeklyBtn.addEventListener('click', () => {
            updateCharts('weekly');
            weeklyBtn.classList.add('active');
            dailyBtn.classList.remove('active');
        });
        dailyBtn.addEventListener('click', () => {
            updateCharts('daily');
            dailyBtn.classList.add('active');
            weeklyBtn.classList.remove('active');
        });

        fetchDataAndRender();
    });
</script>
{% endblock %}