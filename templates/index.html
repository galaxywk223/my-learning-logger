{% extends "base.html" %}

{% block title %}学习记录{% endblock %}

{% block content %}
<style>
    /* Styles are unchanged */
    .page-header-records {
        margin-bottom: 2rem;
    }

    .accordion-item {
        border-color: #E5E7EB;
        background-color: transparent;
        border-radius: var(--border-radius-md) !important;
        overflow: hidden;
        margin-bottom: 1rem;
        box-shadow: var(--box-shadow);
    }

    .accordion-button {
        background-color: var(--color-card-bg);
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--color-text-dark);
    }

    .accordion-button:not(.collapsed) {
        background-color: var(--color-primary-light);
        color: var(--color-primary-dark);
        box-shadow: none;
    }

    .accordion-button:focus {
        box-shadow: none;
        border-color: var(--color-primary);
    }

    .accordion-button::after {
        filter: invert(40%) sepia(9%) saturate(200%) saturate(135%) hue-rotate(176deg) brightness(96%) contrast(94%);
    }

    .accordion-button:not(.collapsed)::after {
        filter: none;
    }

    .accordion-body {
        padding: 1rem 1.5rem;
        background-color: #FDFDFD;
    }

    .day-card {
        border: 1px solid #F3F4F6;
        border-radius: var(--border-radius-md);
        margin-bottom: 1rem;
    }

    .day-card .card-header {
        background-color: #F9FAFB;
        font-weight: 500;
    }

    .log-table {
        margin-bottom: 0;
        table-layout: fixed;
        width: 100%;
    }

    .log-table th {
        font-weight: 500;
        color: var(--color-text-medium);
        font-size: 0.85rem;
        text-transform: uppercase;
        padding: 0.75rem;
    }

    .log-table td {
        vertical-align: middle;
        padding: 0.75rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .action-btn {
        color: var(--color-text-medium);
        padding: 0.25rem 0.5rem;
        text-decoration: none;
        transition: color 0.2s;
    }

    .action-btn:hover {
        color: var(--color-primary);
    }

    .action-btn.delete:hover {
        color: #EF4444;
    }

    .action-btn i {
        width: 18px;
        height: 18px;
    }

    .log-notes td {
        white-space: normal;
    }

    .mood-icon {
        font-size: 1.25rem;
    }
</style>

<div class="page-header-records d-flex justify-content-between align-items-center">
    <div>
        <h1>学习记录</h1>
        <p class="lead text-secondary mb-0">按周查看您的所有学习日志。</p>
    </div>
    <div class="d-flex align-items-center gap-2">
        <div class="btn-group">
            <a href="{{ url_for('records.list_records', sort='desc') }}"
               class="btn btn-sm btn-outline-secondary {% if current_sort == 'desc' %}active{% endif %}">降序</a>
            <a href="{{ url_for('records.list_records', sort='asc') }}"
               class="btn btn-sm btn-outline-secondary {% if current_sort == 'asc' %}active{% endif %}">升序</a>
        </div>
        <button class="btn btn-primary d-flex align-items-center gap-2" data-bs-toggle="modal"
                data-bs-target="#formModal" data-url="{{ url_for('records.get_add_form') }}">
            <i data-lucide="plus-circle"></i>
            <span>添加新记录</span>
        </button>
    </div>
</div>

{% if not setup_needed and structured_logs %}
<div class="accordion" id="weeksAccordion">
    {% set palettes = ['palette-purple', 'palette-green', 'palette-blue', 'palette-yellow', 'palette-red'] %}
    {% for week in structured_logs %}
    <div class="accordion-item {{ palettes[loop.index0 % palettes|length] }}">
        <h2 class="accordion-header" id="heading-{{ week.year }}-{{ week.week_num }}">
            <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapse-{{ week.year }}-{{ week.week_num }}">
                <span class="flex-grow-1 me-3">{{ week.year }} 年 - 第 {{ week.week_num }} 周</span>
                <span class="badge bg-secondary">周平均效率: {{ week.efficiency|round(1, 'floor') }}</span>
            </button>
        </h2>
        <div id="collapse-{{ week.year }}-{{ week.week_num }}"
             class="accordion-collapse collapse {% if loop.first %}show{% endif %}" data-bs-parent="#weeksAccordion">
            <div class="accordion-body">
                {% for day in week.days %}
                <div class="card day-card day-card-{{ loop.index0 % 2 }}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>{{ day.date.strftime('%Y-%m-%d') }} (周{{ ['一','二','三','四','五','六','日'][day.date.weekday()] }})</span>
                        <span class="badge bg-info text-dark">日效率积分: {{ day.efficiency|round(1, 'floor') }}</span>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover log-table">
                            <thead>
                            <tr>
                                <th style="width: 45%;">任务</th>
                                <th style="width: 25%;">时间段</th>
                                <th style="width: 15%;">时长</th>
                                <th style="width: 5%;" class="text-center">心情</th>
                                <th style="width: 10%;" class="text-end"></th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for log in day.logs %}
                            <tr>
                                <td title="{{ log.task }}"><strong>{{ log.task }}</strong></td>
                                <td title="{{ log.time_slot }}">{{ log.time_slot }}</td>
                                <td>{{ log.actual_duration }} 分钟</td>
                                <td class="text-center mood-icon">{{ log.mood | mood_emoji }}</td>
                                <td class="text-end">
                                    <a href="#" class="action-btn" data-bs-toggle="modal" data-bs-target="#formModal"
                                       data-url="{{ url_for('records.get_edit_form', log_id=log.id) }}" title="编辑"><i
                                            data-lucide="file-pen-line"></i></a>
                                    <a href="#" class="action-btn delete" onclick="confirmDelete(event, {{ log.id }})"
                                       title="删除"><i data-lucide="trash-2"></i></a>
                                </td>
                            </tr>
                            {% if log.notes %}
                            <tr class="log-notes">
                                <td colspan="5" class="text-muted small ps-4 py-1" title="{{ log.notes }}">{{ log.notes
                                    }}
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}<p class="text-center text-muted p-3">这一周没有记录。</p>{% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center p-5">
    <h3>还没有任何记录</h3>
    <p class="text-muted">点击右上角的“添加新记录”按钮，开始你的第一条学习日志吧！</p>
</div>
{% endif %}

<div class="modal fade" id="formModal" tabindex="-1" aria-labelledby="formModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content"></div>
    </div>
</div>
<form id="deleteForm" method="POST" style="display: none;"><input type="hidden" name="csrf_token"
                                                                  value="{{ csrf_token() if csrf_token else '' }}">
</form>
{% endblock %}

{% block scripts %}
<script>
    const formModal = document.getElementById('formModal');
    if (formModal) {
        formModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const url = button.getAttribute('data-url');
            const modalContent = formModal.querySelector('.modal-content');

            fetch(url)
                .then(response => response.text())
                .then(html => {
                    // *** BUG FIX: Manually find and execute the script ***
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, "text/html");

                    // Set the HTML content first
                    modalContent.innerHTML = doc.body.innerHTML;

                    // Find all script tags in the loaded content and execute them
                    const scripts = doc.head.getElementsByTagName('script');
                    for (let i = 0; i < scripts.length; i++) {
                        const script = document.createElement('script');
                        script.text = scripts[i].innerText;
                        // It's safer to append to head to ensure execution context
                        document.head.appendChild(script).parentNode.removeChild(script);
                    }
                    const bodyScripts = doc.body.getElementsByTagName('script');
                     for (let i = 0; i < bodyScripts.length; i++) {
                        const script = document.createElement('script');
                        script.text = bodyScripts[i].innerText;
                        document.head.appendChild(script).parentNode.removeChild(script);
                    }

                    lucide.createIcons();
                })
                .catch(err => console.error('Failed to load modal content:', err));
        });
    }

    function submitAjaxForm(form) {
        const formData = new FormData(form);
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    const errorDiv = form.querySelector('.error-message');
                    if (errorDiv) {
                        errorDiv.textContent = data.message || '操作失败，请重试。';
                        errorDiv.style.display = 'block';
                    } else {
                        alert("操作失败: " + (data.message || '未知错误'));
                    }
                }
            })
            .catch(err => {
                console.error('AJAX form submission error:', err);
                alert('发生网络错误，请稍后重试。');
            });
    }

    function confirmDelete(event, logId) {
        event.preventDefault();
        if (confirm('确定要删除这条记录吗？此操作无法撤销。')) {
            fetch(`/records/delete/${logId}`, {
                method: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('删除失败: ' + data.message);
                    }
                })
                .catch(err => {
                    console.error('Delete error:', err);
                    alert('删除时发生网络错误。');
                });
        }
    }

    lucide.createIcons();
</script>
{% endblock %}